---
title: Configuring Cloud Foundry for BOSH Backup and Restore
owner: BBR
---

This topic describes the configuration you need for your Cloud Foundry deployment
to work with BOSH Backup and Restore (BBR).

This topic assumes that you are using [cf-deployment](https://github.com/cloudfoundry/cf-deployment)
with ops files for your Cloud Foundry deployment.

If you do not use ops files for customization,
you can still customize your Cloud Foundry to use BBR.
Examine the contents of the ops files on this page,
and use them as a guide to customize your deployment manifest directly.

<div class="note warning">
  <strong>WARNING</strong>:
  <ul>
    <li><strong>Backup artifacts can contain secrets.</strong> Secure backup artifacts with encryption or by other means.</li>
    <li><strong>The restore is a destructive operation.</strong> BBR is designed to restore CF after a disaster.
        If it fails, the environment can be left in an unusable state and require reprovisioning.
        For the generic method of restoring a deployment, see <a href="restore.html">Restoring with BOSH Backup and Restore</a>.</li>
    <li><strong>Developers are unable to push apps for a few minutes during backup and restore.</strong>
        This is because the Cloud Controller API (CC API) stops sending and receiving calls
        between the <code>pre-backup-lock</code> and <code>post-backup-unlock</code> stages of the process.</li>
    <li><strong>BBR does not back up any service data.</strong>
        Back up Service data, such as Redis or RabbitMQ data, separately.</li>
  </ul>
</div>

## <a id='configure-cf'></a>Supported CF Configurations

To enable backup and restore for your `cf-deployment`, deploy it with the [`enable-backup-restore.yml`](https://github.com/cloudfoundry/cf-deployment/blob/master/operations/backup-and-restore/enable-backup-restore.yml) ops file. This will enable BBR backup and restore for all the default CF components.

To enable BBR backup and restore for different configurations you must in addition use the appropriate backup and restore ops files from this table:

<table class="nice">
  <tr>
    <th>Configuration</th>
    <th>Configuration Ops File</th>
    <th>Backup and Restore Ops File</th>
  </tr>
  <tr>
    <td>
      A versioned S3-compatible external blobstore. For instructions, see <a href="external-blobstores.html">Backup and Restore with External Blobstores</a>.
    </td>
    <td>
      <code>use-s3-blobstore.yml</code>
    </td>
    <td>
      <a href="https://github.com/cloudfoundry/cf-deployment/blob/master/operations/backup-and-restore/enable-backup-restore-s3-versioned.yml">
        <code>enable-backup-restore-s3-versioned.yml</code></a>
    </td>
  </tr>
  <tr>
    <td>
      An unversioned S3-compatible external blobstore. For instructions, see <a href="external-blobstores.html">Backup and Restore with External Blobstores</a>.
    </td>
    <td>
      <code>use-s3-blobstore.yml</code>
    </td>
    <td>
      <a href="https://github.com/cloudfoundry/cf-deployment/blob/master/operations/backup-and-restore/enable-backup-restore-s3-unversioned.yml">
        <code>enable-backup-restore-s3-unversioned.yml</code></a>
    </td>
  </tr>
  <tr>
    <td>
      A <a href="#supported-external-databases">supported external database</a>
    </td>
    <td>
      <code>use-external-dbs.yml</code>
    </td>
    <td>
      No BBR ops file required
    </td>
  </tr>
  <tr>
    <td>
      An NFS broker and volume driver for volume support
    </td>
    <td>
      <code>enable-nfs-volume-service.yml</code>
    </td>
    <td>
      <a href="https://github.com/cloudfoundry/cf-deployment/blob/master/operations/backup-and-restore/enable-backup-restore-nfs-broker.yml">
      <code>enable-backup-restore-nfs-broker.yml</code></a>
    </td>
  </tr>
  <tr>
    <td>
      Use CredHub for service credentials (experimental)<br>
    </td>
    <td>
      <code>secure-service-credentials.yml</code>
    </td>
    <td>
      <a href="https://github.com/cloudfoundry/cf-deployment/blob/master/operations/backup-and-restore/enable-backup-restore-credhub.yml">
      <code>enable-backup-restore-credhub.yml</code></a>
    </td>
  </tr>
</table>

### <a id='supported-external-databases'></a>Supported External Databases
Cloud Foundry components use the backup and restore SDK to interface with databases for backup and restore.
The backup and restore SDK supports the following database versions:

| Name     | Version |
|:---------|:--------|
| MariaDB  | 10.1.x  |
| MySQL    | 5.5.x   |
| MySQL    | 5.6.x   |
| MySQL    | 5.7.x   |
| Postgres | 9.4.x   |
| Postgres | 9.6.x   |


## <a id="order"></a> Apply Ops Files in the Correct Order

Select the ops files you need and apply them in the following order:

<p class="note"><strong>Note</strong>: This is the <em>relative</em> order.
You do not have to apply all ops files listed below and you can apply other ops files in between.<br>
For example, you can apply an ops file between <code>use-external-dbs.yml</code> and <code>enable-backup-restore.yml</code>,
but do not apply <code>enable-backup-restore.yml</code> <em>before</em> <code>use-external-dbs.yml</code>.
</p>

1. `use-s3-blobstore.yml`

1. `use-external-dbs.yml`

1. `enable-nfs-volume-service.yml`

1. `secure-service-credentials.yml`

1. `enable-backup-restore.yml`

1. `enable-backup-restore-s3-versioned.yml` or `enable-backup-restore-s3-unversioned.yml`

1. `enable-backup-restore-nfs-broker.yml`

1. `enable-backup-restore-credhub.yml`

## <a id='process'></a> Next Steps

After Cloud Foundry is configured to be compatible with BBR,
it can be backed up and restored.

Follow the procedures in [Back Up a BOSH Deployment](backup.html#back-up-deployment)
and [Restore a BOSH Deployment](restore.html#restore-deployment).

At minimum, run the pre-backup check against your Cloud Foundry deployment.
Follow the first two steps of [Back Up a BOSH Deployment](./backup.html#back-up-deployment).
This lists the scripts that run during a backup and the order that they are applied in.
